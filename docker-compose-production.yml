version: '3.8'
services:
  frontend:
    image: registry.promo.it/naturalee:latest
    restart: unless-stopped
    tty: true
    healthcheck:
      test: "curl -f http://localhost:3000"
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s
    deploy:
      placement:
        constraints:
          - "node.role==worker"
          - "node.labels.env==test"
    networks:
      - proxy_net
      - stack
  restarter:
    image: docker:cli
    restart: unless-stopped
    volumes: ["/var/run/docker.sock:/var/run/docker.sock"]
    entrypoint: ["/bin/sh","-c"]
    command:
      - |
        while true; do
          # l'orario Ã¨ indietro di 2 ore!
          if [ "$$(date +'%H:%M')" = '2:00' ] || [ "$$(date +'%H:%M')" = '6:00' ] || [ "$$(date +'%H:%M')" = '10:00' ] || [ "$$(date +'%H:%M')" = '14:00' ] || [ "$$(date +'%H:%M')" = '18:00' ] || [ "$$(date +'%H:%M')" = '22:00' ]; then
            docker service update naturalee_frontend --force
          fi
          sleep 60
        done

# Networks
networks:
  stack:
    driver: overlay
  proxy_net:
    external: true
