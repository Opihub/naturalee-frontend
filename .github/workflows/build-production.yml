name: üöÄ Generazione immagine Docker per produzione

on:
  push:
    branches: [master]

jobs:
  webserver-docker-deploy:
    runs-on: ubuntu-latest
    name: üéâ Compile and publish frontend
    env:
      APP_TITLE: ${{ vars.PROD_APP_TITLE }}
      NUXT_PUBLIC_SITE_URL: ${{ vars.PROD_SITE_URL }}
      API_ENDPOINT_URL: ${{ vars.PROD_API_ENDPOINT_URL }}
      STRIPE_PUBLIC_KEY: ${{ vars.PROD_STRIPE_PUBLIC_KEY }}
      RECAPTCHA_PUBLIC_KEY: ${{ vars.RECAPTCHA_PUBLIC_KEY }}
      GTM_ID: ${{ vars.PROD_GTM_ID }}
      GTM_DEBUG: ${{ vars.PROD_GTM_DEBUG }}
      GTM_ENABLED: ${{ vars.PROD_GTM_ENABLED }}
      IUBENDA_ID: ${{ vars.IUBENDA_ID }}
      IUBENDA_SITE_ID: ${{ vars.IUBENDA_SITE_ID }}
      WEBPUSHR_TOKEN: ${{ vars.PROD_WEBPUSHR_TOKEN }}
      IS_PRODUCTION: false
      VITE_SITE_URL: ${{ vars.PROD_SITE_URL }}
      VITE_API_ENDPOINT_URL: ${{ vars.PROD_API_ENDPOINT_URL }}
      SENTRY_DSN: ${{ vars.SENTRY_DSN }}
      SENTRY_ENVIRONMENT: production
      SENTRY_AUTH_TOKEN: ${{ secrets.SENTRY_AUTH_TOKEN }}
    steps:
      - name: üöö Get latest code
        uses: actions/checkout@v2
        with:
          fetch-depth: 10

      - name: Generazione del file .env
        run: |
          chmod +x ./env.sh
          ./env.sh -o .env.production
          cat .env.production
        shell: bash

      - name: üèó Build and push to local registry
        uses: mr-smithers-excellent/docker-build-push@v5
        with:
          image: naturalee
          tags: latest
          registry: registry.promo.it
          dockerfile: ./docker/production/DockerFile
          username: ${{ secrets.REGISTRY_USERNAME }}
          password: ${{ secrets.REGISTRY_PASSWORD }}
